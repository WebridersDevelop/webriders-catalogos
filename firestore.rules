rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Funciones helper para verificar roles
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    function isClient() {
      return isAuthenticated() && getUserData().role == 'client';
    }

    function getClientId() {
      return getUserData().clientId;
    }

    function isOwnerOfCatalog(catalogId) {
      let catalogData = get(/databases/$(database)/documents/catalogs/$(catalogId)).data;
      return catalogData.clientId == getClientId();
    }

    // Colección de usuarios (almacena roles)
    match /users/{userId} {
      // Solo admins pueden leer todos los usuarios
      allow read: if isAdmin() || request.auth.uid == userId;

      // Solo admins pueden crear/actualizar usuarios
      allow create, update: if isAdmin();

      // Los usuarios pueden actualizar su propio perfil (excepto role)
      allow update: if request.auth.uid == userId &&
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'clientId']);
    }

    // Reglas para catálogos
    match /catalogs/{catalogId} {
      // Lectura pública de catálogos
      allow read: if true;

      // Admin puede crear cualquier catálogo
      allow create: if isAdmin();

      // Admin puede actualizar/eliminar cualquier catálogo
      // Cliente solo puede actualizar/eliminar sus propios catálogos
      allow update, delete: if isAdmin() || (isClient() && isOwnerOfCatalog(catalogId));

      // Reglas para productos dentro de un catálogo
      match /products/{productId} {
        // Lectura pública de productos
        allow read: if true;

        // Admin puede modificar cualquier producto
        // Cliente solo puede modificar productos de sus catálogos
        allow create, update, delete: if isAdmin() || (isClient() && isOwnerOfCatalog(catalogId));
      }
    }

    // Colección de datos de clientes
    match /clients/{clientId} {
      // Admin puede leer todos los clientes
      // Cliente solo puede leer sus propios datos
      allow read: if isAdmin() || (isClient() && getClientId() == clientId);

      // Solo admin puede crear/eliminar clientes
      allow create, delete: if isAdmin();

      // Admin puede actualizar cualquier cliente
      // Cliente puede actualizar sus propios datos (excepto campos críticos)
      allow update: if isAdmin() ||
        (isClient() && getClientId() == clientId &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['catalogIds', 'status']));
    }
  }
}
